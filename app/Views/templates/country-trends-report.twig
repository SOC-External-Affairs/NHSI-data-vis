<div class="wrap">
    <h1>{{ page_title }}</h1>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% include 'report-styles.twig' %}

    <div class="postbox">
        <div class="inside">
            {% if data %}
                <div class="chart-container" style="width: 100%; height: 400px;">
                    <canvas id="countryTrendsChart"></canvas>
                </div>
                <table class="wp-list-table widefat striped">
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Year</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                            <tr>
                                <td>{{ row.home_country }}</td>
                                <td>{{ row.year_attended }}</td>
                                <td><strong>{{ row.count }}</strong></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No country trend data available.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
{% if data %}
const years = [{% for year in years %}'{{ year }}'{% if not loop.last %},{% endif %}{% endfor %}];
const countries = [{% for country in countries %}'{{ country }}'{% if not loop.last %},{% endif %}{% endfor %}];
const chartData = {{ chartData|json_encode|raw }};
const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A'];

const datasets = countries.map((country, index) => ({
    label: country,
    data: years.map(year => chartData[country] && chartData[country][year] ? parseInt(chartData[country][year]) : 0),
    borderColor: colors[index % colors.length],
    backgroundColor: colors[index % colors.length] + '20',
    borderWidth: 2,
    fill: false,
    tension: 0.1
}));

new Chart(document.getElementById('countryTrendsChart'), {
    type: 'line',
    data: {
        labels: years,
        datasets: datasets
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Number of Students'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Year'
                }
            }
        },
        plugins: {
            legend: {
                position: 'right'
            },
            title: {
                display: true,
                text: 'Student Count by Country and Year'
            }
        }
    }
});
{% else %}
console.log('No data available for chart');
{% endif %}
</script>