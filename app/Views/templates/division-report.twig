<div class="wrap">
    <h1>{{ page_title }}</h1>
    {% include 'report-styles.twig' %}
    
    <div class="postbox">
        <div class="inside">
            {% if sankeyData %}
                <div style="display: flex; gap: 20px; margin-bottom: 15px; align-items: center;">
                    <div>
                        <label for="year-filter">Year:</label>
                        <select id="year-filter" style="margin-left: 5px; padding: 5px;">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div>
                        <label for="state-filter">State:</label>
                        <select id="state-filter" style="margin-left: 5px; padding: 5px;">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div>
                        <label for="division-filter">Division:</label>
                        <select id="division-filter" style="margin-left: 5px; padding: 5px;">
                            <option value="">All Divisions</option>
                        </select>
                    </div>
                    <button id="reset-filters" style="padding: 5px 10px; background: #2271b1; color: white; border: none; border-radius: 3px; cursor: pointer;">Reset</button>
                </div>
                
                <div id="detail-panel" style="background: #f0f6fc; padding: 10px; margin-bottom: 15px; border-radius: 5px; display: none;">
                    <h3 id="detail-title">Select filters to see details</h3>
                    <div id="detail-content"></div>
                </div>
                
                <div id="sankey-chart" style="width: 100%; height: 700px;"></div>
                <div id="sankey-message" style="display: none; padding: 20px; text-align: center; color: #666;">Please select at least 2 filters to view the Sankey diagram</div>
                
                <table class="wp-list-table widefat striped" style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>State</th>
                            <th>Division</th>
                            <th>Primary Major</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody id="data-table">
                        {% for row in data %}
                            <tr data-year="{{ row.year_attended }}" data-state="{{ row.home_state }}" data-division="{{ row.division }}">
                                <td>{{ row.year_attended }}</td>
                                <td>{{ row.home_state }}</td>
                                <td>{{ row.division }}</td>
                                <td><strong>{{ row.count }}</strong></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No division data available.</p>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<script>
{% if sankeyData %}
// Store the data from the server (PHP sends this data to JavaScript)
const originalSankeyData = {{ sankeyData|json_encode|raw }};
const rawData = {{ data|json_encode|raw }};

// Set up spacing around the chart so it doesn't touch the edges
const margin = {top: 50, right: 50, bottom: 50, left: 50};
// Calculate how wide the chart should be (container width minus left and right margins)
const width = document.getElementById('sankey-chart').offsetWidth - margin.left - margin.right;
// Calculate how tall the chart should be (700px minus top and bottom margins)
const height = 700 - margin.top - margin.bottom;

// Define colors for each category (Year, State, Division, Major)
const color = d3.scaleOrdinal()
    .domain(['year', 'state', 'division', 'major'])
    .range(['#2271b1', '#135e96', '#d63384', '#28a745']);

// Create tooltip element
const tooltip = d3.select('body').append('div')
    .style('position', 'absolute')
    .style('background', 'rgba(0, 0, 0, 0.8)')
    .style('color', 'white')
    .style('padding', '10px')
    .style('border-radius', '5px')
    .style('pointer-events', 'none')
    .style('display', 'none')
    .style('z-index', '1000');

function showTooltip(event, d) {
    let info = `<strong>${d.value} students</strong><br>`;
    if (d.year) info += `Year: ${d.year}<br>`;
    if (d.state) info += `State: ${d.state}<br>`;
    if (d.division) info += `Division: ${d.division}<br>`;
    info += `${d.source.name} → ${d.target.name}`;
    
    tooltip.html(info)
        .style('display', 'block')
        .style('left', (event.pageX + 10) + 'px')
        .style('top', (event.pageY - 10) + 'px');
}

function hideTooltip() {
    tooltip.style('display', 'none');
}

function buildFilteredSankeyData(year, state, division) {
    const filteredRawData = rawData.filter(row => {
        return (!year || row.year_attended === year) &&
               (!state || row.home_state === state) &&
               (!division || row.division === division);
    });
    
    if (filteredRawData.length === 0) {
        return { nodes: [], links: [] };
    }
    
    const nodeSet = new Set();
    const linkMap = new Map();
    
    filteredRawData.forEach(row => {
        const year = row.year_attended;
        const state = row.home_state;
        const division = row.division;
        const major = row.primary_major || 'Unknown';
        const count = parseInt(row.count);
        
        nodeSet.add(`year:${year}`);
        nodeSet.add(`state:${state}`);
        nodeSet.add(`division:${division}`);
        nodeSet.add(`major:${major}`);
        
        const link1Key = `${year}|${state}`;
        const link2Key = `${state}|${division}`;
        const link3Key = `${division}|${major}`;
        
        linkMap.set(link1Key, (linkMap.get(link1Key) || 0) + count);
        linkMap.set(link2Key, (linkMap.get(link2Key) || 0) + count);
        linkMap.set(link3Key, (linkMap.get(link3Key) || 0) + count);
    });
    
    const nodes = Array.from(nodeSet).map(n => {
        const [category, name] = n.split(':');
        return { name, category };
    });
    
    const nodeMap = new Map();
    nodes.forEach((node, i) => nodeMap.set(node.name, i));
    
    const links = [];
    linkMap.forEach((value, key) => {
        const [source, target] = key.split('|');
        links.push({
            source: nodeMap.get(source),
            target: nodeMap.get(target),
            value: value
        });
    });
    
    return { nodes, links };
}

function renderSankey(sankeyData) {
    d3.select('#sankey-chart svg').remove();
    
    const svg = d3.select('#sankey-chart')
        .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
    
    const sankey = d3.sankey()
        .nodeWidth(15)
        .nodePadding(10)
        .extent([[1, 1], [width - 1, height - 6]]);
    
    const {nodes, links} = sankey(sankeyData);
    
    svg.append('g')
        .selectAll('path')
        .data(links)
        .join('path')
        .attr('d', d3.sankeyLinkHorizontal())
        .attr('stroke', '#aaa')
        .attr('stroke-width', d => Math.max(1, d.width))
        .attr('fill', 'none')
        .attr('opacity', 0.5)
        .style('cursor', 'pointer')
        .on('mouseover', function(event, d) {
            d3.select(this).attr('opacity', 1).attr('stroke', '#ff6b35');
            showTooltip(event, d);
        })
        .on('mouseout', function(event, d) {
            d3.select(this).attr('opacity', 0.5).attr('stroke', '#aaa');
            hideTooltip();
        });
    
    svg.append('g')
        .selectAll('rect')
        .data(nodes)
        .join('rect')
        .attr('x', d => d.x0)
        .attr('y', d => d.y0)
        .attr('height', d => d.y1 - d.y0)
        .attr('width', d => d.x1 - d.x0)
        .attr('fill', d => color(d.category))
        .attr('stroke', '#000')
        .attr('stroke-width', 0.5);
    
    svg.append('g')
        .selectAll('text')
        .data(nodes)
        .join('text')
        .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
        .attr('y', d => (d.y1 + d.y0) / 2)
        .attr('dy', '0.35em')
        .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
        .text(d => d.name)
        .style('font-size', '12px')
        .style('font-family', 'Arial, sans-serif')
        .style('font-weight', 'normal');
}

// Build the dropdown filter options from the data
const years = [...new Set(rawData.map(row => row.year_attended))].sort();
const states = [...new Set(rawData.map(row => row.home_state))].sort();
const divisions = [...new Set(rawData.map(row => row.division))].sort();

years.forEach(year => {
    document.getElementById('year-filter').innerHTML += `<option value="${year}">${year}</option>`;
});

states.forEach(state => {
    const selected = state === 'IL' ? ' selected' : '';
    document.getElementById('state-filter').innerHTML += `<option value="${state}"${selected}>${state}</option>`;
});

divisions.forEach(division => {
    document.getElementById('division-filter').innerHTML += `<option value="${division}">${division}</option>`;
});

document.getElementById('year-filter').addEventListener('change', updateFilters);
document.getElementById('state-filter').addEventListener('change', updateFilters);
document.getElementById('division-filter').addEventListener('change', updateFilters);
document.getElementById('reset-filters').addEventListener('click', resetFilters);

updateFilters();

function updateFilters() {
    const selectedYear = document.getElementById('year-filter').value;
    const selectedState = document.getElementById('state-filter').value;
    const selectedDivision = document.getElementById('division-filter').value;
    
    const filterCount = [selectedYear, selectedState, selectedDivision].filter(f => f).length;
    
    if (filterCount < 1) {
        document.getElementById('sankey-chart').style.display = 'none';
        document.getElementById('sankey-message').style.display = 'block';
        document.getElementById('sankey-message').innerHTML = 'Please select at least 1 filter to view the Sankey diagram';
        document.getElementById('detail-panel').style.display = 'none';
        filterTableByDropdowns(selectedYear, selectedState, selectedDivision);
        return;
    }
    
    document.getElementById('sankey-chart').style.display = 'block';
    document.getElementById('sankey-message').style.display = 'none';
    
    const filteredData = buildFilteredSankeyData(selectedYear, selectedState, selectedDivision);
    
    if (filteredData.links.length === 0) {
        document.getElementById('sankey-chart').style.display = 'none';
        document.getElementById('sankey-message').innerHTML = 'No data available for selected filters';
        document.getElementById('sankey-message').style.display = 'block';
        return;
    }
    
    renderSankey(filteredData);
    showFilterDetails(selectedYear, selectedState, selectedDivision, filteredData.links);
    filterTableByDropdowns(selectedYear, selectedState, selectedDivision);
}

function showFilterDetails(year, state, division, matchingFlows) {
    const panel = document.getElementById('detail-panel');
    const title = document.getElementById('detail-title');
    const content = document.getElementById('detail-content');
    
    if (!year && !state && !division) {
        panel.style.display = 'none';
        return;
    }
    
    panel.style.display = 'block';
    
    let filters = [];
    if (year) filters.push(`Year: ${year}`);
    if (state) filters.push(`State: ${state}`);
    if (division) filters.push(`Division: ${division}`);
    
    title.textContent = filters.join(' | ');
    
    const totalStudents = matchingFlows.reduce((sum, link) => sum + link.value, 0);
    
    let details = `<strong>${totalStudents} students</strong><br><br>`;
    
    if (!division) {
        const divisionCounts = {};
        matchingFlows.forEach(link => {
            divisionCounts[link.division] = (divisionCounts[link.division] || 0) + link.value;
        });
        details += '<strong>By Division:</strong><br>';
        Object.entries(divisionCounts).sort((a, b) => b[1] - a[1]).forEach(([div, count]) => {
            details += `&nbsp;&nbsp;• ${div}: ${count}<br>`;
        });
    }
    
    if (!year) {
        const yearCounts = {};
        matchingFlows.forEach(link => {
            yearCounts[link.year] = (yearCounts[link.year] || 0) + link.value;
        });
        details += '<br><strong>By Year:</strong><br>';
        Object.entries(yearCounts).sort((a, b) => a[0].localeCompare(b[0])).forEach(([yr, count]) => {
            details += `&nbsp;&nbsp;• ${yr}: ${count}<br>`;
        });
    }
    
    if (!state) {
        const stateCounts = {};
        matchingFlows.forEach(link => {
            stateCounts[link.state] = (stateCounts[link.state] || 0) + link.value;
        });
        details += '<br><strong>By State:</strong><br>';
        Object.entries(stateCounts).sort((a, b) => b[1] - a[1]).slice(0, 5).forEach(([st, count]) => {
            details += `&nbsp;&nbsp;• ${st}: ${count}<br>`;
        });
        if (Object.keys(stateCounts).length > 5) {
            details += `&nbsp;&nbsp;• ...and ${Object.keys(stateCounts).length - 5} more states<br>`;
        }
    }
    
    content.innerHTML = details;
}

function filterTableByDropdowns(year, state, division) {
    const rows = document.querySelectorAll('#data-table tr');
    rows.forEach(row => {
        const rowYear = row.dataset.year;
        const rowState = row.dataset.state;
        const rowDivision = row.dataset.division;
        const yearMatch = !year || rowYear === year;
        const stateMatch = !state || rowState === state;
        const divisionMatch = !division || rowDivision === division;
        row.style.display = (yearMatch && stateMatch && divisionMatch) ? '' : 'none';
    });
}

function resetFilters() {
    document.getElementById('year-filter').value = '';
    document.getElementById('state-filter').value = 'IL';
    document.getElementById('division-filter').value = '';
    document.getElementById('detail-panel').style.display = 'none';
    const rows = document.querySelectorAll('#data-table tr');
    rows.forEach(row => row.style.display = '');
    updateFilters();
}
{% endif %}
</script>